# git のbranch を表示
autoload -U add-zsh-hook
autoload -Uz vcs_info

_set_tmux_window() {
  if [ "$TMUX" ]; then
    # tmux display
    #   -p 標準出力へ
    #   #I ウィンドウ番号
    #   #P ペイン番号
    export TMUX_WINDOW=$(tmux display -p '#I-#P')
  fi
}

# prompt-git-current-branch
function current_branch {
  if [[ "$PWD" = ${DOTFILES}'/\.git(/.*)?$' ]]; then
    echo "%{%B${fg[black]}%}no git%{${reset_color}%}%b"
    return
  fi
  name=$(basename "`git symbolic-ref HEAD 2> /dev/null`")
  if [[ -z $name ]]; then
    echo "%{%B${fg[black]}%} branch %{${reset_color}%}%b"
    return
  fi
  st=`git status 2> /dev/null`
  if [[ -n `echo "$st" | grep "^nothing to"` ]]; then
    color=${bg[blue]}${fg[green]}
  elif [[ -n `echo "$st" | grep "^nothing added"` ]]; then
    color=${bg[red]}${fg[blue]}
  elif [[ -n `echo "$st" | grep "^# Untracked"` ]]; then
    color=${bg[red]}${fg_bold[white]}
  else
    color=${bg[red]}${fg_bold[white]}
  fi
  # %{...%} は囲まれた文字列がエスケープシーケンスであることを明示する
  # これをしないと右プロンプトの位置がずれる
  echo "%{$color%}%{%B%} $name %{%b%}%{$reset_color%}"
}

#======================================================================
# https://gist.github.com/yonchu/3935922
#======================================================================
#cd後自動でls
function chpwd() { ls_abbrev }

ls_abbrev() {
  # -a : Do not ignore entries starting with ..
  # -C : Force multi-column output.
  # -F : Append indicator (one of */=>@|) to entries.
  local cmd_ls='ls'
  local -a opt_ls
  opt_ls=('-CF' '--color=always')
  case "${OSTYPE}" in
  freebsd*|darwin*)
    if type gls > /dev/null 2>&1; then
      cmd_ls='gls'
    else
      # -G : Enable colorized output.
      opt_ls=('-aCFG')
    fi
    ;;
  esac

  local ls_result
    ls_result=$(CLICOLOR_FORCE=1 COLUMNS=$COLUMNS command $cmd_ls ${opt_ls[@]} | sed $'/^\e\[[0-9;]*m$/d')

    local ls_lines=$(echo "$ls_result" | wc -l | tr -d ' ')

    if [ $ls_lines -gt  6 ]; then
      echo "$ls_result" | head -n 3
      echo '...'
      echo "$ls_result" | tail -n 3
      echo "$(command ls -1 -A | wc -l | tr -d ' ') files exist"
    else
      echo "$ls_result"
    fi
}

# 時刻更新
function TRAPALRM () { zle reset-prompt }
TMOUT=60
